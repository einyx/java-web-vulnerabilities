package de.marko.pentest.rest.handler;

import de.marko.pentest.db.DatabaseJPAConnector;
import de.marko.pentest.db.entity.User;
import io.vertx.core.Handler;
import io.vertx.ext.web.RoutingContext;
import java.nio.charset.StandardCharsets;
import java.util.Base64;

/**
 * @author marko
 * @version 1.0.0.
 * @date 05.01.2018
 */
public class GetTokenHandlerV4 implements Handler<RoutingContext> {

	@Override
	public void handle(RoutingContext routingContext) {

		byte[] name = Base64.getDecoder().decode(routingContext.request().getParam("name"));

		byte[] password = Base64.getDecoder().decode(routingContext.request().getParam("password"));

		String query = new StringBuilder("SELECT u.id, u.name, u.password, u.token, u.version")
			.append(" FROM Users u")
			.append(" WHERE name = '").append(new String(name, StandardCharsets.UTF_8))
			.append("' AND password = '").append(new String(password, StandardCharsets.UTF_8))
			.append("'")
			.toString();

		User user = DatabaseJPAConnector.connect()
			.nativeSelectQuery(query, User.class)
			.stream()
			.findFirst()
			.orElse(null);

		if (user != null) {
			routingContext.response().setStatusCode(200).end(user.getToken());
		} else {
			routingContext.response().setStatusCode(500).end("");
		}
	}

}
