package de.marko.pentest.rest.handler;

import de.marko.pentest.db.DatabaseJPAConnector;
import de.marko.pentest.db.SqlArguments;
import de.marko.pentest.db.entity.User;
import io.vertx.core.Handler;
import io.vertx.ext.web.RoutingContext;
import java.util.HashMap;

/**
 * @author mawn
 * @version 1.0.0.
 * @date 05.01.2018
 */
public class GetTokenHandler implements Handler<RoutingContext> {

	@Override
	public void handle(RoutingContext routingContext) {

		String name = routingContext.request().getParam("name");

		String password = routingContext.request().getParam("password");

		String query = "SELECT t FROM User t WHERE name= :name AND password = :password";

		HashMap<String, Object> params = SqlArguments.builder().add("name", name)
			.add("password", password).create();

		User user = DatabaseJPAConnector.connect()
			.getResultsFromJPQLSelectQuery(query, User.class, params)
			.stream()
			.findFirst()
			.orElse(null);

		if(user != null) {
			routingContext.response().setStatusCode(200).end(user.getToken());
		} else {
			routingContext.response().setStatusCode(500).end("");
		}
	}

}
