package de.marko.pentest;

import de.marko.pentest.db.VulnDB;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.Properties;
import org.apache.commons.dbcp2.BasicDataSource;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import org.hibernate.cfg.AvailableSettings;

/**
 * @author marko
 * @version 1.0.0.
 * @date 19.08.2017
 */
public class Main {

	static final Logger log = LogManager.getLogger(Main.class);

	public static void main(String[] args) throws Exception {

		log.info("Start vulnerable web app ...");

		initDB();

		HttpAPIServer apiServer = HttpAPIServer.getInstance();

	}

	private static void initDB() throws IOException {
		File dbconfig = new File("vuln.properties");

		Properties dbProps = new Properties();
		dbProps.load(Files.newInputStream(dbconfig.toPath()));

		BasicDataSource dbcpDataSource = new BasicDataSource();
		dbcpDataSource.setUrl(dbProps.getProperty(AvailableSettings.URL));
		dbcpDataSource.setDriverClassName(dbProps.getProperty(AvailableSettings.DRIVER));
		dbcpDataSource.setMaxOpenPreparedStatements(50);
		dbcpDataSource.setTestOnBorrow(true);
		dbcpDataSource
			.setValidationQuery(dbProps.getProperty("hibernate.dbcp.validationQuery"));
		dbcpDataSource.setValidationQueryTimeout(900);

		dbProps.remove(AvailableSettings.URL);
		dbProps.remove(AvailableSettings.USER);
		dbProps.remove(AvailableSettings.PASS);
		dbProps.remove(AvailableSettings.DRIVER);
		dbProps.remove("hibernate.dbcp.validationQuery");

		// lade von properties
		VulnDB.initialize("vuln", dbProps, dbcpDataSource);
	}

}
