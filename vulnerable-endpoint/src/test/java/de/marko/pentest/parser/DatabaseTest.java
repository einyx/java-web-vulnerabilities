package de.marko.pentest.parser;

import de.marko.pentest.db.VulnDB;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.util.Properties;
import org.apache.commons.dbcp2.BasicDataSource;
import org.hibernate.cfg.AvailableSettings;

/**
 * @author mawn
 * @version 1.0.0.
 * @date 05.01.2018
 */
public class DatabaseTest {

	public void setup(String database) throws IOException {

		ClassLoader classLoader = getClass().getClassLoader();

		File dbconfig = new File(classLoader.getResource("vuln.properties").getFile());

		Properties dbProps = new Properties();
		dbProps.load(Files.newInputStream(dbconfig.toPath()));

		BasicDataSource dbcpDataSource = new BasicDataSource();
		dbcpDataSource.setUrl(dbProps.getProperty(AvailableSettings.URL));
		dbcpDataSource.setDriverClassName(dbProps.getProperty(AvailableSettings.DRIVER));
		dbcpDataSource.setMaxOpenPreparedStatements(50);
		dbcpDataSource.setTestOnBorrow(true);
		dbcpDataSource
			.setValidationQuery(dbProps.getProperty("hibernate.dbcp.validationQuery"));
		dbcpDataSource.setValidationQueryTimeout(900);

		dbProps.remove(AvailableSettings.URL);
		dbProps.remove(AvailableSettings.USER);
		dbProps.remove(AvailableSettings.PASS);
		dbProps.remove(AvailableSettings.DRIVER);
		dbProps.remove("hibernate.dbcp.validationQuery");

		// lade von properties
		VulnDB.initialize(database, dbProps, dbcpDataSource);
	}

}
